<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6ãƒ»7ãƒ»8ã®æ®µ ä¹ä¹ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    <!-- Tailwind CSS (ãƒ‡ã‚¶ã‚¤ãƒ³ç”¨) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ã‚¢ã‚¤ã‚³ãƒ³ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Verdana', sans-serif; touch-action: manipulation; }
        .btn-press { transition: transform 0.1s; }
        .btn-press:active { transform: scale(0.95); }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* ç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; display: none; }
        .confetti-piece { position: absolute; width: 10px; height: 10px; background: #ffd700; top: -10px; opacity: 0; }
        @keyframes fall {
            0% { top: -10%; transform: translateX(0) rotate(0deg); opacity: 1; }
            100% { top: 110%; transform: translateX(100px) rotate(360deg); opacity: 0; }
        }
    </style>
</head>
<body class="bg-blue-50 text-gray-800 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="app" class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden relative min-h-[500px] flex flex-col">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-indigo-600 p-4 text-white text-center">
            <h1 class="text-xl font-bold"><i class="fas fa-shapes mr-2"></i>6ãƒ»7ãƒ»8ã®æ®µ ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
        <div id="content" class="flex-1 p-6 flex flex-col items-center justify-center relative">
            <!-- JavaScriptã§ã“ã“ã«ç”»é¢ã‚’æç”»ã—ã¾ã™ -->
            <div class="animate-pulse text-indigo-500">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div class="bg-gray-100 p-2 text-center text-xs text-gray-500">
            Powered by Firebase
        </div>

        <!-- ç´™å¹é›ªç”¨ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="confetti-container" class="confetti"></div>
    </div>

    <!-- Firebase SDK (CDN Moduleå½¢å¼) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ==========================================
        // --- Firebaseè¨­å®šï¼ˆã“ã“ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼‰ ---
        // Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã€>ã€Œãƒã‚¤ã‚¢ãƒ—ãƒªã€ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„
        // ==========================================
        const firebaseConfig = {
  apiKey: "AIzaSyATwDH_QmfcO4J1sGLaFCAe9lZ6dCuFW44",
  authDomain: "nodan-d4c56.firebaseapp.com",
  projectId: "nodan-d4c56",
  storageBucket: "nodan-d4c56.firebasestorage.app",
  messagingSenderId: "662440516870",
  appId: "1:662440516870:web:2c34ca5500aad21a955287",
  measurementId: "G-DP984V1305"
};
        // ==========================================

        // ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–
        let app, auth, db, currentUser;
        
        // é–‹ç™ºç’°å¢ƒç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆCanvasç’°å¢ƒãªã©configãŒç©ºã®å ´åˆã®ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
        try {
            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                console.warn("Firebaseè¨­å®šãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§ã™ã€‚æ­£ã—ãå‹•ä½œã—ã¾ã›ã‚“ã€‚");
                // ãƒ‡ãƒ¢ç”¨ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã¿ã§å‹•ããƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹ã‹ã€ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™ãªã©ã®å‡¦ç†
                document.getElementById('content').innerHTML = `
                    <div class="text-red-500 text-center">
                        <p class="font-bold mb-2">è¨­å®šãŒå¿…è¦ã§ã™</p>
                        <p class="text-sm">index.htmlå†…ã®firebaseConfigã‚’<br>æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚</p>
                    </div>`;
            } else {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // åŒ¿åãƒ­ã‚°ã‚¤ãƒ³
                signInAnonymously(auth).catch((error) => {
                    console.error("Auth Error:", error);
                    alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                });
            }
        } catch (e) {
            console.error("Init Error:", e);
        }

        // --- ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ç®¡ç† ---
        const state = {
            screen: 'loading', // loading, login, home, game, result
            handleName: localStorage.getItem('kuku_handleName') || '',
            questions: [],
            currentQuestionIndex: 0,
            startTime: 0,
            endTime: 0,
            correctCount: 0,
            personalBest: null, // { time: number, date: string }
            dailyHighScores: []
        };

        // --- DOMè¦ç´  ---
        const contentDiv = document.getElementById('content');
        const confettiDiv = document.getElementById('confetti-container');

        // --- èªè¨¼çŠ¶æ…‹ã®ç›£è¦– ---
        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    // åå‰ãŒãªã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ã€ã‚ã‚Œã°ãƒ›ãƒ¼ãƒ ã¸
                    if (!state.handleName) {
                        changeScreen('login');
                    } else {
                        await loadRecords();
                        changeScreen('home');
                    }
                }
            });
        }

        // --- ç”»é¢é·ç§»ç®¡ç† ---
        async function changeScreen(screenName) {
            state.screen = screenName;
            contentDiv.innerHTML = ''; // ç”»é¢ã‚¯ãƒªã‚¢
            contentDiv.className = "flex-1 p-6 flex flex-col items-center justify-center relative fade-in";

            switch (screenName) {
                case 'login':
                    renderLogin();
                    break;
                case 'home':
                    renderHome();
                    break;
                case 'game':
                    renderGame();
                    break;
                case 'result':
                    renderResult();
                    break;
            }
        }

        // --- 1. ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ç™»éŒ²ï¼‰ç”»é¢ ---
        function renderLogin() {
            contentDiv.innerHTML = `
                <div class="text-center w-full">
                    <h2 class="text-xl font-bold mb-6 text-indigo-700">ãŠåå‰ã‚’ãŠã—ãˆã¦ã­</h2>
                    <input type="text" id="handleNameInput" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " maxlength="10"
                        class="w-full p-4 border-2 border-indigo-200 rounded-xl text-center text-xl mb-4 focus:outline-none focus:border-indigo-500">
                    <button id="saveNameBtn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-md btn-press">
                        ã¯ã˜ã‚ã‚‹
                    </button>
                </div>
            `;
            
            document.getElementById('saveNameBtn').onclick = async () => {
                const name = document.getElementById('handleNameInput').value.trim();
                if (name) {
                    state.handleName = name;
                    localStorage.setItem('kuku_handleName', name);
                    await loadRecords();
                    changeScreen('home');
                }
            };
        }

        // --- 2. ãƒ›ãƒ¼ãƒ ç”»é¢ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºï¼‰ ---
        function renderHome() {
            // å€‹äººã®è‡ªå·±ãƒ™ã‚¹ãƒˆè¡¨ç¤ºæ•´å½¢
            let bestText = '<span class="text-gray-400">-</span>';
            if (state.personalBest) {
                bestText = `<span class="text-amber-500 font-bold">${(state.personalBest.time / 1000).toFixed(1)}ç§’</span>`;
            }

            // ä»Šæ—¥ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”Ÿæˆ
            const rankingHtml = state.dailyHighScores.length > 0 
                ? state.dailyHighScores.map((s, i) => `
                    <div class="flex justify-between items-center text-sm border-b border-gray-100 py-2">
                        <span class="font-bold w-6 text-indigo-400">${i + 1}.</span>
                        <span class="flex-1 truncate text-gray-700">${s.handleName}</span>
                        <span class="font-bold text-gray-600">${(s.timeTaken / 1000).toFixed(1)}ç§’</span>
                    </div>
                `).join('')
                : '<div class="text-center text-gray-400 text-sm py-4">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ä¸€ç•ªä¹—ã‚Šã‚’ç›®æŒ‡ãã†ï¼</div>';

            contentDiv.innerHTML = `
                <div class="w-full max-w-sm">
                    <div class="bg-indigo-50 rounded-xl p-4 mb-6 shadow-inner">
                        <p class="text-sm text-gray-500 mb-1 text-center">ã“ã‚“ã«ã¡ã¯ã€<span class="font-bold text-indigo-600">${state.handleName}</span>ã•ã‚“</p>
                        <div class="flex justify-between items-center bg-white p-3 rounded-lg border border-indigo-100">
                            <span class="text-xs font-bold text-gray-500">è‡ªå·±ãƒ™ã‚¹ãƒˆ</span>
                            <span class="text-xl">${bestText}</span>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-sm font-bold text-gray-500 mb-2 pl-2"><i class="fas fa-trophy text-yellow-400 mr-1"></i>ä»Šæ—¥ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚° (TOP 5)</h3>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-2 min-h-[150px]">
                            ${rankingHtml}
                        </div>
                    </div>

                    <button id="startBtn" class="w-full bg-gradient-to-r from-pink-500 to-rose-500 text-white text-xl font-bold py-4 px-6 rounded-2xl shadow-lg btn-press transform hover:-translate-y-1 transition-all">
                        <i class="fas fa-play mr-2"></i>ã‚¹ã‚¿ãƒ¼ãƒˆï¼
                    </button>
                    
                    <button id="changeNameBtn" class="mt-4 text-xs text-gray-400 underline w-full text-center">
                        åå‰ã‚’å¤‰ãˆã‚‹
                    </button>
                </div>
            `;

            document.getElementById('startBtn').onclick = startGame;
            document.getElementById('changeNameBtn').onclick = () => {
                localStorage.removeItem('kuku_handleName');
                state.handleName = '';
                changeScreen('login');
            };
        }

        // --- 3. ã‚²ãƒ¼ãƒ ç”»é¢ ---
        function startGame() {
            // å•é¡Œç”Ÿæˆï¼ˆ6,7,8ã®æ®µï¼‰
            const targets = [6, 7, 8];
            const allQuestions = [];
            targets.forEach(t => {
                for (let i = 1; i <= 9; i++) {
                    allQuestions.push({ q: `${t} Ã— ${i}`, a: t * i });
                }
            });

            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦5å•æŠ½å‡º
            state.questions = allQuestions
                .sort(() => Math.random() - 0.5)
                .slice(0, 5);
            
            state.currentQuestionIndex = 0;
            state.correctCount = 0;
            state.startTime = Date.now();
            changeScreen('game');
        }

        function renderGame() {
            const question = state.questions[state.currentQuestionIndex];
            
            contentDiv.innerHTML = `
                <div class="w-full h-full flex flex-col justify-between">
                    <div class="flex justify-between text-gray-400 text-sm mb-4">
                        <span>ç¬¬ ${state.currentQuestionIndex + 1} / 5 å•</span>
                        <span id="timer">0.0ç§’</span>
                    </div>

                    <div class="flex-1 flex flex-col items-center justify-center mb-8">
                        <div class="text-6xl font-bold text-indigo-800 mb-8 tracking-wider font-mono">
                            ${question.q}
                        </div>
                        <div id="answerDisplay" class="h-16 text-4xl font-bold text-gray-600 border-b-4 border-indigo-200 w-32 text-center">
                            ?
                        </div>
                    </div>

                    <!-- ãƒ†ãƒ³ã‚­ãƒ¼ -->
                    <div class="grid grid-cols-3 gap-2 w-full max-w-xs mx-auto">
                        ${[7,8,9,4,5,6,1,2,3,0].map(n => `
                            <button class="num-key bg-white border border-gray-200 rounded-lg py-4 text-xl font-bold shadow-sm active:bg-indigo-50 btn-press" data-num="${n}">${n}</button>
                        `).join('')}
                        <button class="col-span-2 bg-gray-200 rounded-lg py-4 text-gray-600 font-bold btn-press" id="clearBtn">ã‘ã™</button>
                    </div>
                </div>
            `;

            let currentInput = "";
            let timerInterval = setInterval(() => {
                const elapsed = (Date.now() - state.startTime) / 1000;
                const timerEl = document.getElementById('timer');
                if(timerEl) timerEl.innerText = elapsed.toFixed(1) + "ç§’";
            }, 100);

            // ãƒ†ãƒ³ã‚­ãƒ¼å…¥åŠ›å‡¦ç†
            document.querySelectorAll('.num-key').forEach(btn => {
                btn.onclick = () => {
                    const num = btn.dataset.num;
                    if (currentInput.length < 3) {
                        currentInput += num;
                        updateDisplay();
                        checkAnswer();
                    }
                };
            });

            document.getElementById('clearBtn').onclick = () => {
                currentInput = "";
                updateDisplay();
            };

            function updateDisplay() {
                const display = document.getElementById('answerDisplay');
                display.innerText = currentInput || "?";
                display.classList.remove('text-gray-600');
                display.classList.add('text-indigo-600');
            }

            function checkAnswer() {
                const val = parseInt(currentInput);
                if (val === question.a) {
                    // æ­£è§£
                    clearInterval(timerInterval);
                    state.correctCount++;
                    document.getElementById('answerDisplay').classList.add('text-green-500');
                    
                    setTimeout(() => {
                        nextQuestion();
                    }, 300); // å°‘ã—å¾…ã£ã¦æ¬¡ã¸
                } else if (currentInput.length >= String(question.a).length) {
                    // æ¡æ•°ãŒé”ã—ã¦é–“é•ã£ã¦ã„ã‚‹å ´åˆï¼ˆå³æ™‚åˆ¤å®šã¯ã›ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¶ˆã™ã®ã‚’å¾…ã¤ãªã‚‰ã“ã“ã¯ä½•ã‚‚ã—ãªã„ã€‚ä»Šå›ã¯ç°¡æ˜“UXã®ãŸã‚ã€é–“é•ã£ã¦ãŸã‚‰èµ¤ãã—ã¦ãƒªã‚»ãƒƒãƒˆï¼‰
                    const display = document.getElementById('answerDisplay');
                    display.classList.add('text-red-500');
                    setTimeout(() => {
                        currentInput = "";
                        updateDisplay();
                        display.classList.remove('text-red-500');
                    }, 500);
                }
            }

            function nextQuestion() {
                state.currentQuestionIndex++;
                if (state.currentQuestionIndex >= 5) {
                    state.endTime = Date.now();
                    finishGame();
                } else {
                    clearInterval(timerInterval); // å‰ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’æ¶ˆã™
                    renderGame(); // å†æç”»
                }
            }
        }

        async function finishGame() {
            const timeTaken = state.endTime - state.startTime;
            const isFullCombo = state.correctCount === 5;
            let isNewRecord = false;

            // å…¨å•æ­£è§£ãªã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
            if (isFullCombo && auth && currentUser) {
                // è‡ªå·±ãƒ™ã‚¹ãƒˆæ›´æ–°åˆ¤å®š
                if (!state.personalBest || timeTaken < state.personalBest.time) {
                    isNewRecord = true;
                }

                try {
                    // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ (collection: scores)
                    // ãƒ«ãƒ¼ãƒ«: artifacts/{appId}/public/data/scores
                    const todayStr = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                    const scoreData = {
                        uid: currentUser.uid,
                        handleName: state.handleName,
                        score: state.correctCount,
                        timeTaken: timeTaken,
                        dateString: todayStr,
                        createdAt: Timestamp.now()
                    };

                    await addDoc(collection(db, 'artifacts', firebaseConfig.appId, 'public', 'data', 'scores'), scoreData);
                    
                    // è¨˜éŒ²ã‚’å†èª­ã¿è¾¼ã¿
                    await loadRecords();

                } catch (e) {
                    console.error("Save Error", e);
                }
            }

            state.lastResult = { timeTaken, isFullCombo, isNewRecord };
            changeScreen('result');
        }

        // --- 4. çµæœç”»é¢ ---
        function renderResult() {
            const { timeTaken, isFullCombo, isNewRecord } = state.lastResult;
            const timeSec = (timeTaken / 1000).toFixed(1);

            let message = "";
            let colorClass = "text-gray-700";
            
            if (isFullCombo) {
                if (isNewRecord) {
                    message = "ğŸ‰ æ–°è¨˜éŒ²ãŠã‚ã§ã¨ã†ï¼ ğŸ‰";
                    colorClass = "text-pink-600 animate-bounce";
                    startConfetti();
                } else {
                    message = "å…¨å•æ­£è§£ï¼ã™ã”ã„ï¼";
                    colorClass = "text-orange-500";
                }
            } else {
                message = "ãŠã—ã„ï¼å…¨éƒ¨ã¨ã‘ã‚‹ã‹ãªï¼Ÿ";
                colorClass = "text-blue-500";
            }

            contentDiv.innerHTML = `
                <div class="text-center w-full">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold ${colorClass} mb-2">${message}</h2>
                        <div class="text-6xl font-bold text-indigo-900 font-mono my-6">
                            ${timeSec}<span class="text-2xl ml-2 text-gray-500">ç§’</span>
                        </div>
                        <div class="flex justify-center space-x-4 text-sm text-gray-500">
                            <div>æ­£è§£æ•°: <span class="font-bold text-gray-800">${state.correctCount}</span>/5</div>
                        </div>
                    </div>

                    ${isNewRecord ? `<div class="bg-yellow-100 border-2 border-yellow-300 text-yellow-800 p-3 rounded-lg mb-6 font-bold text-sm">
                        <i class="fas fa-crown mr-1"></i> ä»Šæ—¥ã®è‡ªå·±ãƒ™ã‚¹ãƒˆæ›´æ–°ï¼
                    </div>` : ''}

                    <button id="retryBtn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-md btn-press mb-4">
                        ã‚‚ã†ä¸€å›ã‚„ã‚‹
                    </button>
                    <button id="homeBtn" class="w-full bg-white border-2 border-indigo-100 text-indigo-500 font-bold py-3 px-6 rounded-xl btn-press">
                        ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                    </button>
                </div>
            `;

            document.getElementById('retryBtn').onclick = () => {
                stopConfetti();
                startGame();
            };
            document.getElementById('homeBtn').onclick = () => {
                stopConfetti();
                changeScreen('home');
            };
        }

        // --- ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ ---
        // è¤‡é›‘ãªã‚¯ã‚¨ãƒªï¼ˆorderBy, whereã®è¤‡åˆï¼‰ã‚’é¿ã‘ã‚‹ãŸã‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™
        async function loadRecords() {
            if (!db) return;

            const todayStr = new Date().toISOString().split('T')[0];
            const scoresRef = collection(db, 'artifacts', firebaseConfig.appId, 'public', 'data', 'scores');
            
            try {
                // ã‚·ãƒ³ãƒ—ãƒ«ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— (æœ¬ç•ªã‚¢ãƒ—ãƒªã§ã¯ãƒ‡ãƒ¼ã‚¿é‡ã«æ³¨æ„ãŒå¿…è¦ã§ã™ãŒã€å­¦ç¿’ç”¨ã‚¢ãƒ—ãƒªã®è¦æ¨¡ãªã‚‰è¨±å®¹ç¯„å›²)
                // â€»æœ¬æ¥ã¯ composite index ã‚’ä½œã£ã¦ query(scoresRef, where('dateString', '==', todayStr)) ã™ã¹ãã§ã™ãŒ
                // indexä½œæˆã®æ‰‹é–“ã‚’çœããŸã‚å…¨ä»¶å–å¾—ã—ã¦JSã§ãƒ•ã‚£ãƒ«ã‚¿ã—ã¾ã™ã€‚
                const snapshot = await getDocs(scoresRef);
                const allScores = [];
                
                snapshot.forEach(doc => {
                    allScores.push(doc.data());
                });

                // 1. ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿æŠ½å‡º
                const todaysData = allScores.filter(d => d.dateString === todayStr && d.score === 5); // 5å•æ­£è§£ã®ã¿

                // 2. è‡ªå·±ãƒ™ã‚¹ãƒˆç®—å‡º
                const myRecords = allScores.filter(d => d.uid === currentUser.uid && d.score === 5);
                if (myRecords.length > 0) {
                    // æ™‚é–“ãŒçŸ­ã„é †
                    myRecords.sort((a, b) => a.timeTaken - b.timeTaken);
                    state.personalBest = { time: myRecords[0].timeTaken };
                } else {
                    state.personalBest = null;
                }

                // 3. ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä½œæˆï¼ˆæ™‚é–“ãŒçŸ­ã„é †ï¼‰
                todaysData.sort((a, b) => a.timeTaken - b.timeTaken);
                
                // é‡è¤‡ãƒ¦ãƒ¼ã‚¶ãƒ¼é™¤å»ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ãƒ™ã‚¹ãƒˆã®ã¿æ®‹ã™ï¼‰
                const uniqueRanking = [];
                const seenUsers = new Set();
                for (const rec of todaysData) {
                    if (!seenUsers.has(rec.uid)) {
                        seenUsers.add(rec.uid);
                        uniqueRanking.push(rec);
                    }
                    if (uniqueRanking.length >= 5) break;
                }
                
                state.dailyHighScores = uniqueRanking;

            } catch (e) {
                console.error("Load Error:", e);
            }
        }

        // --- ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ (ç°¡æ˜“CSSå®Ÿè£…) ---
        function startConfetti() {
            confettiDiv.style.display = 'block';
            confettiDiv.innerHTML = '';
            const colors = ['#EF4444', '#3B82F6', '#10B981', '#F59E0B', '#8B5CF6'];
            
            for (let i = 0; i < 50; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = Math.random() * 100 + '%';
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                piece.style.animation = `fall ${Math.random() * 3 + 2}s linear infinite`;
                piece.style.animationDelay = Math.random() * 2 + 's';
                confettiDiv.appendChild(piece);
            }
        }

        function stopConfetti() {
            confettiDiv.style.display = 'none';
            confettiDiv.innerHTML = '';
        }

    </script>
</body>
</html>